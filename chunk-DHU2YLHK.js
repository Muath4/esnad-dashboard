import{a as nt,b as H,c as it,d as X,e as st,f as rt,g as at,h as z,i as ot,j as lt,k as ct,l as dt}from"./chunk-ILINP27B.js";import{a as tt,b as $,c as et}from"./chunk-GNGW5BZZ.js";import{a as v}from"./chunk-5POVDAZT.js";import{a as R}from"./chunk-NFKFJGEM.js";import{d as j}from"./chunk-5YHN6KDB.js";import{a as I}from"./chunk-KIJFJ5WB.js";import{a as _}from"./chunk-DFOWQSZE.js";import{c as M,d as F,m as Y,p as Z}from"./chunk-BX6Q2EGA.js";import"./chunk-D4IA4D73.js";import{Da as G,I as D,N as P,P as U,Z as b,h as u,ha as E,j as s}from"./chunk-YMYRQ6W5.js";import"./chunk-NE7DEP4F.js";import"./chunk-337ES2G7.js";import"./chunk-OWRAVFPR.js";import{a as J,b as Q,h as T}from"./chunk-FU75TI2F.js";var f={},x={},ft={},xt=u(()=>{x={},ft={},f={}},"clear"),O=u((e,t)=>(s.trace("In isDescendant",t," ",e," = ",x[t].includes(e)),!!x[t].includes(e)),"isDescendant"),St=u((e,t)=>(s.info("Descendants of ",t," is ",x[t]),s.info("Edge is ",e),e.v===t||e.w===t?!1:x[t]?x[t].includes(e.v)||O(e.v,t)||O(e.w,t)||x[t].includes(e.w):(s.debug("Tilt, ",t,",not in descendants"),!1)),"edgeInCluster"),ht=u((e,t,n,a)=>{s.warn("Copying children of ",e,"root",a,"data",t.node(e),a);let i=t.children(e)||[];e!==a&&i.push(e),s.warn("Copying (nodes) clusterId",e,"nodes",i),i.forEach(r=>{if(t.children(r).length>0)ht(r,t,n,a);else{let c=t.node(r);s.info("cp ",r," to ",a," with parent ",e),n.setNode(r,c),a!==t.parent(r)&&(s.warn("Setting parent",r,t.parent(r)),n.setParent(r,t.parent(r))),e!==a&&r!==e?(s.debug("Setting parent",r,e),n.setParent(r,e)):(s.info("In copy ",e,"root",a,"data",t.node(e),a),s.debug("Not Setting parent for node=",r,"cluster!==rootId",e!==a,"node!==clusterId",r!==e));let h=t.edges(r);s.debug("Copying Edges",h),h.forEach(d=>{s.info("Edge",d);let g=t.edge(d.v,d.w,d.name);s.info("Edge data",g,a);try{St(d,a)?(s.info("Copying as ",d.v,d.w,g,d.name),n.setEdge(d.v,d.w,g,d.name),s.info("newGraph edges ",n.edges(),n.edge(n.edges()[0]))):s.info("Skipping copy of edge ",d.v,"-->",d.w," rootId: ",a," clusterId:",e)}catch(y){s.error(y)}})}s.debug("Removing node",r),t.removeNode(r)})},"copy"),ut=u((e,t)=>{let n=t.children(e),a=[...n];for(let i of n)ft[i]=e,a=[...a,...ut(i,t)];return a},"extractDescendants"),B=u((e,t)=>{s.trace("Searching",e);let n=t.children(e);if(s.trace("Searching children of id ",e,n),n.length<1)return s.trace("This is a valid node",e),e;for(let a of n){let i=B(a,t);if(i)return s.trace("Found replacement for",e," => ",i),i}},"findNonClusterChild"),A=u(e=>!f[e]||!f[e].externalConnections?e:f[e]?f[e].id:e,"getAnchorId"),Nt=u((e,t)=>{if(!e||t>10){s.debug("Opting out, no graph ");return}else s.debug("Opting in, graph ");e.nodes().forEach(function(n){e.children(n).length>0&&(s.warn("Cluster identified",n," Replacement id in edges: ",B(n,e)),x[n]=ut(n,e),f[n]={id:B(n,e),clusterData:e.node(n)})}),e.nodes().forEach(function(n){let a=e.children(n),i=e.edges();a.length>0?(s.debug("Cluster identified",n,x),i.forEach(r=>{if(r.v!==n&&r.w!==n){let c=O(r.v,n),h=O(r.w,n);c^h&&(s.warn("Edge: ",r," leaves cluster ",n),s.warn("Descendants of XXX ",n,": ",x[n]),f[n].externalConnections=!0)}})):s.debug("Not a cluster ",n,x)});for(let n of Object.keys(f)){let a=f[n].id,i=e.parent(a);i!==n&&f[i]&&!f[i].externalConnections&&(f[n].id=i)}e.edges().forEach(function(n){let a=e.edge(n);s.warn("Edge "+n.v+" -> "+n.w+": "+JSON.stringify(n)),s.warn("Edge "+n.v+" -> "+n.w+": "+JSON.stringify(e.edge(n)));let i=n.v,r=n.w;if(s.warn("Fix XXX",f,"ids:",n.v,n.w,"Translating: ",f[n.v]," --- ",f[n.w]),f[n.v]&&f[n.w]&&f[n.v]===f[n.w]){s.warn("Fixing and trixing link to self - removing XXX",n.v,n.w,n.name),s.warn("Fixing and trixing - removing XXX",n.v,n.w,n.name),i=A(n.v),r=A(n.w),e.removeEdge(n.v,n.w,n.name);let c=n.w+"---"+n.v;e.setNode(c,{domId:c,id:c,labelStyle:"",labelText:a.label,padding:0,shape:"labelRect",style:""});let h=structuredClone(a),d=structuredClone(a);h.label="",h.arrowTypeEnd="none",d.label="",h.fromCluster=n.v,d.toCluster=n.v,e.setEdge(i,c,h,n.name+"-cyclic-special"),e.setEdge(c,r,d,n.name+"-cyclic-special")}else if(f[n.v]||f[n.w]){if(s.warn("Fixing and trixing - removing XXX",n.v,n.w,n.name),i=A(n.v),r=A(n.w),e.removeEdge(n.v,n.w,n.name),i!==n.v){let c=e.parent(i);f[c].externalConnections=!0,a.fromCluster=n.v}if(r!==n.w){let c=e.parent(r);f[c].externalConnections=!0,a.toCluster=n.w}s.warn("Fix Replacing with XXX",i,r,n.name),e.setEdge(i,r,a,n.name)}}),s.warn("Adjusted Graph",v(e)),gt(e,0),s.trace(f)},"adjustClustersAndEdges"),gt=u((e,t)=>{if(s.warn("extractor - ",t,v(e),e.children("D")),t>10){s.error("Bailing out");return}let n=e.nodes(),a=!1;for(let i of n){let r=e.children(i);a=a||r.length>0}if(!a){s.debug("Done, no node has children",e.nodes());return}s.debug("Nodes = ",n,t);for(let i of n)if(s.debug("Extracting node",i,f,f[i]&&!f[i].externalConnections,!e.parent(i),e.node(i),e.children("D")," Depth ",t),!f[i])s.debug("Not a cluster",i,t);else if(!f[i].externalConnections&&e.children(i)&&e.children(i).length>0){s.warn("Cluster without external connections, without a parent and with children",i,t);let c=e.graph().rankdir==="TB"?"LR":"TB";f[i]?.clusterData?.dir&&(c=f[i].clusterData.dir,s.warn("Fixing dir",f[i].clusterData.dir,c));let h=new _({multigraph:!0,compound:!0}).setGraph({rankdir:c,nodesep:50,ranksep:50,marginx:8,marginy:8}).setDefaultEdgeLabel(function(){return{}});s.warn("Old graph before copy",v(e)),ht(i,e,h,i),e.setNode(i,{clusterNode:!0,id:i,clusterData:f[i].clusterData,labelText:f[i].labelText,graph:h}),s.warn("New graph after copy node: (",i,")",v(h)),s.debug("Old graph after copy",v(e))}else s.warn("Cluster ** ",i," **not meeting the criteria !externalConnections:",!f[i].externalConnections," no parent: ",!e.parent(i)," children ",e.children(i)&&e.children(i).length>0,e.children("D"),t),s.debug(f);n=e.nodes(),s.warn("New list of nodes",n);for(let i of n){let r=e.node(i);s.warn(" Now next level",i,r),r.clusterNode&&gt(r.graph,t+1)}},"extractor"),wt=u((e,t)=>{if(t.length===0)return[];let n=Object.assign(t);return t.forEach(a=>{let i=e.children(a),r=wt(e,i);n=[...n,...r]}),n},"sorter"),Et=u(e=>wt(e,e.children()),"sortNodesByHierarchy"),Ct=u((e,t)=>{s.info("Creating subgraph rect for ",t.id,t);let n=b(),a=e.insert("g").attr("class","cluster"+(t.class?" "+t.class:"")).attr("id",t.id),i=a.insert("rect",":first-child"),r=D(n.flowchart.htmlLabels),c=a.insert("g").attr("class","cluster-label"),h=t.labelType==="markdown"?j(c,t.labelText,{style:t.labelStyle,useHtmlLabels:r},n):c.node().appendChild(H(t.labelText,t.labelStyle,void 0,!0)),d=h.getBBox();if(D(n.flowchart.htmlLabels)){let o=h.children[0],l=E(h);d=o.getBoundingClientRect(),l.attr("width",d.width),l.attr("height",d.height)}let g=0*t.padding,y=g/2,w=t.width<=d.width+g?d.width+g:t.width;t.width<=d.width+g?t.diff=(d.width-t.width)/2-t.padding/2:t.diff=-t.padding/2,s.trace("Data ",t,JSON.stringify(t)),i.attr("style",t.style).attr("rx",t.rx).attr("ry",t.ry).attr("x",t.x-w/2).attr("y",t.y-t.height/2-y).attr("width",w).attr("height",t.height+g);let{subGraphTitleTopMargin:m}=R(n);r?c.attr("transform",`translate(${t.x-d.width/2}, ${t.y-t.height/2+m})`):c.attr("transform",`translate(${t.x}, ${t.y-t.height/2+m})`);let p=i.node().getBBox();return t.width=p.width,t.height=p.height,t.intersect=function(o){return X(t,o)},a},"rect"),Tt=u((e,t)=>{let n=e.insert("g").attr("class","note-cluster").attr("id",t.id),a=n.insert("rect",":first-child"),i=0*t.padding,r=i/2;a.attr("rx",t.rx).attr("ry",t.ry).attr("x",t.x-t.width/2-r).attr("y",t.y-t.height/2-r).attr("width",t.width+i).attr("height",t.height+i).attr("fill","none");let c=a.node().getBBox();return t.width=c.width,t.height=c.height,t.intersect=function(h){return X(t,h)},n},"noteGroup"),kt=u((e,t)=>{let n=b(),a=e.insert("g").attr("class",t.classes).attr("id",t.id),i=a.insert("rect",":first-child"),r=a.insert("g").attr("class","cluster-label"),c=a.append("rect"),h=r.node().appendChild(H(t.labelText,t.labelStyle,void 0,!0)),d=h.getBBox();if(D(n.flowchart.htmlLabels)){let o=h.children[0],l=E(h);d=o.getBoundingClientRect(),l.attr("width",d.width),l.attr("height",d.height)}d=h.getBBox();let g=0*t.padding,y=g/2,w=t.width<=d.width+t.padding?d.width+t.padding:t.width;t.width<=d.width+t.padding?t.diff=(d.width+t.padding*0-t.width)/2:t.diff=-t.padding/2,i.attr("class","outer").attr("x",t.x-w/2-y).attr("y",t.y-t.height/2-y).attr("width",w+g).attr("height",t.height+g),c.attr("class","inner").attr("x",t.x-w/2-y).attr("y",t.y-t.height/2-y+d.height-1).attr("width",w+g).attr("height",t.height+g-d.height-3);let{subGraphTitleTopMargin:m}=R(n);r.attr("transform",`translate(${t.x-d.width/2}, ${t.y-t.height/2-t.padding/3+(D(n.flowchart.htmlLabels)?5:3)+m})`);let p=i.node().getBBox();return t.height=p.height,t.intersect=function(o){return X(t,o)},a},"roundedWithTitle"),Dt=u((e,t)=>{let n=e.insert("g").attr("class",t.classes).attr("id",t.id),a=n.insert("rect",":first-child"),i=0*t.padding,r=i/2;a.attr("class","divider").attr("x",t.x-t.width/2-r).attr("y",t.y-t.height/2).attr("width",t.width+i).attr("height",t.height+i);let c=a.node().getBBox();return t.width=c.width,t.height=c.height,t.diff=-t.padding/2,t.intersect=function(h){return X(t,h)},n},"divider"),Xt={rect:Ct,roundedWithTitle:kt,noteGroup:Tt,divider:Dt},yt={},Bt=u((e,t)=>{s.trace("Inserting cluster");let n=t.shape||"rect";yt[t.id]=Xt[n](e,t)},"insertCluster"),Lt=u(()=>{yt={}},"clear"),bt=u((e,t,n,a,i,r)=>T(void 0,null,function*(){s.info("Graph in recursive render: XXX",v(t),i);let c=t.graph().rankdir;s.trace("Dir in recursive render - dir:",c);let h=e.insert("g").attr("class","root");t.nodes()?s.info("Recursive render XXX",t.nodes()):s.info("No nodes found for",t),t.edges().length>0&&s.trace("Recursive edges",t.edge(t.edges()[0]));let d=h.insert("g").attr("class","clusters"),g=h.insert("g").attr("class","edgePaths"),y=h.insert("g").attr("class","edgeLabels"),w=h.insert("g").attr("class","nodes");yield Promise.all(t.nodes().map(function(o){return T(this,null,function*(){let l=t.node(o);if(i!==void 0){let S=JSON.parse(JSON.stringify(i.clusterData));s.info("Setting data for cluster XXX (",o,") ",S,i),t.setNode(i.id,S),t.parent(o)||(s.trace("Setting parent",o,i.id),t.setParent(o,i.id,S))}if(s.info("(Insert) Node XXX"+o+": "+JSON.stringify(t.node(o))),l?.clusterNode){s.info("Cluster identified",o,l.width,t.node(o));let{ranksep:S,nodesep:C}=t.graph();l.graph.setGraph(Q(J({},l.graph.graph()),{ranksep:S,nodesep:C}));let L=yield bt(w,l.graph,n,a,t.node(o),r),N=L.elem;it(l,N),l.diff=L.diff||0,s.info("Node bounds (abc123)",o,l,l.width,l.x,l.y),rt(N,l),s.warn("Recursive render complete ",N,l)}else t.children(o).length>0?(s.info("Cluster - the non recursive path XXX",o,l.id,l,t),s.info(B(l.id,t)),f[l.id]={id:B(l.id,t),node:l}):(s.info("Node - the non recursive path",o,l.id,l),yield st(w,t.node(o),{config:r,dir:c}))})})),t.edges().forEach(function(o){return T(this,null,function*(){let l=t.edge(o.v,o.w,o.name);s.info("Edge "+o.v+" -> "+o.w+": "+JSON.stringify(o)),s.info("Edge "+o.v+" -> "+o.w+": ",o," ",JSON.stringify(t.edge(o))),s.info("Fix",f,"ids:",o.v,o.w,"Translating: ",f[o.v],f[o.w]),yield lt(y,l)})}),t.edges().forEach(function(o){s.info("Edge "+o.v+" -> "+o.w+": "+JSON.stringify(o))}),s.info("Graph before layout:",JSON.stringify(v(t))),s.info("#############################################"),s.info("###                Layout                 ###"),s.info("#############################################"),s.info(t),I(t),s.info("Graph after layout:",JSON.stringify(v(t)));let m=0,{subGraphTitleTotalMargin:p}=R(r);return Et(t).forEach(function(o){let l=t.node(o);s.info("Position "+o+": "+JSON.stringify(t.node(o))),s.info("Position "+o+": ("+l.x,","+l.y,") width: ",l.width," height: ",l.height),l?.clusterNode?(l.y+=p,z(l)):t.children(o).length>0?(l.height+=p,Bt(d,l),f[l.id].node=l):(l.y+=p/2,z(l))}),t.edges().forEach(function(o){let l=t.edge(o);s.info("Edge "+o.v+" -> "+o.w+": "+JSON.stringify(l),l),l.points.forEach(C=>C.y+=p/2);let S=dt(g,o,l,f,n,t,a);ct(l,S)}),t.nodes().forEach(function(o){let l=t.node(o);s.info(o,l.type,l.diff),l.type==="group"&&(m=l.diff)}),{elem:h,diff:m}}),"recursiveRender"),Jt=u((e,t,n,a,i)=>T(void 0,null,function*(){nt(e,n,a,i),at(),ot(),Lt(),xt(),s.warn("Graph at first:",JSON.stringify(v(t))),Nt(t),s.warn("Graph after:",JSON.stringify(v(t)));let r=b();yield bt(e,t,a,i,void 0,r)}),"render"),V=u(e=>P.sanitizeText(e,b()),"sanitizeText"),W={dividerMargin:10,padding:5,textHeight:10,curve:void 0},Rt=u(function(e,t,n,a){s.info("keys:",[...e.keys()]),s.info(e),e.forEach(function(i){let c={shape:"rect",id:i.id,domId:i.domId,labelText:V(i.id),labelStyle:"",style:"fill: none; stroke: black",padding:b().flowchart?.padding??b().class?.padding};t.setNode(i.id,c),pt(i.classes,t,n,a,i.id),s.info("setNode",c)})},"addNamespaces"),pt=u(function(e,t,n,a,i){s.info("keys:",[...e.keys()]),s.info(e),[...e.values()].filter(r=>r.parent===i).forEach(function(r){let c=r.cssClasses.join(" "),h=F(r.styles),d=r.label??r.id,g=0,w={labelStyle:h.labelStyle,shape:"class_box",labelText:V(d),classData:r,rx:g,ry:g,class:c,style:h.style,id:r.id,domId:r.domId,tooltip:a.db.getTooltip(r.id,i)||"",haveCallback:r.haveCallback,link:r.link,width:r.type==="group"?500:void 0,type:r.type,padding:b().flowchart?.padding??b().class?.padding};t.setNode(r.id,w),i&&t.setParent(r.id,i),s.info("setNode",w)})},"addClasses"),_t=u(function(e,t,n,a){s.info(e),e.forEach(function(i,r){let c=i,h="",d={labelStyle:"",style:""},g=c.text,y=0,m={labelStyle:d.labelStyle,shape:"note",labelText:V(g),noteData:c,rx:y,ry:y,class:h,style:d.style,id:c.id,domId:c.id,tooltip:"",type:"note",padding:b().flowchart?.padding??b().class?.padding};if(t.setNode(c.id,m),s.info("setNode",m),!c.class||!a.has(c.class))return;let p=n+r,o={id:`edgeNote${p}`,classes:"relation",pattern:"dotted",arrowhead:"none",startLabelRight:"",endLabelLeft:"",arrowTypeStart:"none",arrowTypeEnd:"none",style:"fill:none",labelStyle:"",curve:M(W.curve,G)};t.setEdge(c.id,c.class,o,p)})},"addNotes"),At=u(function(e,t){let n=b().flowchart,a=0;e.forEach(function(i){a++;let r={classes:"relation",pattern:i.relation.lineType==1?"dashed":"solid",id:Z(i.id1,i.id2,{prefix:"id",counter:a}),arrowhead:i.type==="arrow_open"?"none":"normal",startLabelRight:i.relationTitle1==="none"?"":i.relationTitle1,endLabelLeft:i.relationTitle2==="none"?"":i.relationTitle2,arrowTypeStart:q(i.relation.type1),arrowTypeEnd:q(i.relation.type2),style:"fill:none",labelStyle:"",curve:M(n?.curve,G)};if(s.info(r,i),i.style!==void 0){let c=F(i.style);r.style=c.style,r.labelStyle=c.labelStyle}i.text=i.title,i.text===void 0?i.style!==void 0&&(r.arrowheadStyle="fill: #333"):(r.arrowheadStyle="fill: #333",r.labelpos="c",b().flowchart?.htmlLabels??b().htmlLabels?(r.labelType="html",r.label='<span class="edgeLabel">'+i.text+"</span>"):(r.labelType="text",r.label=i.text.replace(P.lineBreakRegex,`
`),i.style===void 0&&(r.style=r.style||"stroke: #333; stroke-width: 1.5px;fill:none"),r.labelStyle=r.labelStyle.replace("color:","fill:"))),t.setEdge(i.id1,i.id2,r,a)})},"addRelations"),Ot=u(function(e){W=J(J({},W),e)},"setConf"),Pt=u(function(e,t,n,a){return T(this,null,function*(){s.info("Drawing class - ",t);let i=b().flowchart??b().class,r=b().securityLevel;s.info("config:",i);let c=i?.nodeSpacing??50,h=i?.rankSpacing??50,d=new _({multigraph:!0,compound:!0}).setGraph({rankdir:a.db.getDirection(),nodesep:c,ranksep:h,marginx:8,marginy:8}).setDefaultEdgeLabel(function(){return{}}),g=a.db.getNamespaces(),y=a.db.getClasses(),w=a.db.getRelations(),m=a.db.getNotes();s.info(w),Rt(g,d,t,a),pt(y,d,t,a),At(w,d),_t(m,d,w.length+1,y);let p;r==="sandbox"&&(p=E("#i"+t));let o=r==="sandbox"?E(p.nodes()[0].contentDocument.body):E("body"),l=o.select(`[id="${t}"]`),S=o.select("#"+t+" g");if(yield Jt(S,d,["aggregation","extension","composition","dependency","lollipop"],"classDiagram",t),Y.insertTitle(l,"classTitleText",i?.titleTopMargin??5,a.db.getDiagramTitle()),U(d,l,i?.diagramPadding,i?.useMaxWidth),!i?.htmlLabels){let C=r==="sandbox"?p.nodes()[0].contentDocument:document,L=C.querySelectorAll('[id="'+t+'"] .edgeLabel .label');for(let N of L){let K=N.getBBox(),k=C.createElementNS("http://www.w3.org/2000/svg","rect");k.setAttribute("rx",0),k.setAttribute("ry",0),k.setAttribute("width",K.width),k.setAttribute("height",K.height),N.insertBefore(k,N.firstChild)}}})},"draw");function q(e){let t;switch(e){case 0:t="aggregation";break;case 1:t="extension";break;case 2:t="composition";break;case 3:t="dependency";break;case 4:t="lollipop";break;default:t="none"}return t}u(q,"getArrowMarker");var Gt={setConf:Ot,draw:Pt},Qt={parser:tt,db:$,renderer:Gt,styles:et,init:u(e=>{e.class||(e.class={}),e.class.arrowMarkerAbsolute=e.arrowMarkerAbsolute,$.clear()},"init")};export{Qt as diagram};
